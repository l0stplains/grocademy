proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:10m max_size=100m inactive=7d use_temp_path=off;

upstream app_upstream {
  server app:3000;
  keepalive 32;
}

location / {
    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
    proxy_buffering on;

    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;

    proxy_pass http://app_upstream;
}

server {
  listen 80;
  server_name _;

  # allow larger uploads for the module 
  client_max_body_size 100m;

  # gzip basic text assets
  gzip on;
  gzip_types text/plain text/css application/javascript application/json image/svg+xml;
  gzip_min_length 1024;

  # defaults
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  location ~* \.(?:css|js|svg|png|jpg|jpeg|gif|ico|woff2?)$ {
    add_header Cache-Control "public, max-age=604800" always; # 7 days
    proxy_pass http://app_upstream;
  }

  location / {
    proxy_read_timeout 120s;     # long-poll friendly
    proxy_send_timeout 120s;
    proxy_buffering on;
    proxy_pass http://app_upstream;
  }
}
